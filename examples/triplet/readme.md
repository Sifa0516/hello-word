---
title: Triplet and Pair Wise Network Tutorial
description: Train and test a triplet network on data generated by 3D model from PASCAL3D or faces in MultiPIE.
category: example
include_in_docs: true
layout: default
priority: 100
---

# Triplet Network Training with Caffe
This example shows how you can use weight sharing and a triplet loss
function to learn a model using a triplet network in Caffe.

We will assume that you have caffe successfully compiled. If not, please refer
to the [Installation page](../../installation.html). This example builds on the
[MNIST tutorial](mnist.html) so it would be a good idea to read that before
continuing.

*The guide specifies all paths and assumes all commands are executed from the
root caffe directory*

## Filelist Preparation

1 reference samples and 1 positive sample is needed in a triplet set, and the
negative samples could be set free of number. So you can use a file list for training
and testing samples and have a look on the loss.

## Prepare Datasets

You might first need to convert the data from the some .ply models using
opencv_contrib cnn_3donj module if you are doing 3D object recognition issues.
After construcing the binary files including images and labels and put them in
./data/linemod folder, just run:

    ./examples/triplet/create_3d_triplet.sh

After running the script there should be two datasets,
`./examples/triplet/3d_triplet_train_leveldb`, and
`./examples/triplet/3d_triplet_test_leveldb`.

## The Model
First, we will define the model that we want to train using the triplet network.
We will use the convolutional net defined in
`./examples/triplet/3d_triplet.prototxt`.

## Define the triplet Network

In this section we will define the triplet network used for training. The
resulting network is defined in
`./examples/triplet/3d_triplet_train_test.prototxt`.

### Reading in the Triplet Data

We start with a data layer that reads from the LevelDB database we created
earlier. Each entry in this database contains the image data for a triplet of
images (`triplet_data`) and the label (`sim`) is not nessesary in our method.

layer {
name: "data"
type: "Data"
top: "data"
top: "sim"
include {
phase: TRAIN
}
transform_param {
scale: 0.00390625
}
data_param {
source: "examples/triplet/3d_triplet_train_leveldb"
batch_size: 250
}
}

### Adding the Triplet Loss Function

To train the network we will optimize a triplet loss function proposed in:
This cost function is implemented with the `TRIPLET_LOSS` layer:


layer {
name: "loss"
type: "TripletLoss"
bottom: "feat"
bottom: "sim"
top: "loss"
triplet_loss_param {
margin: 1
losstype: 0
num_triplets: 3
}
}

## Define the Solver

Nothing special needs to be done to the solver besides pointing it at the
correct model file. The solver is defined in
`./examples/triplet/3d_triplet_solver.prototxt`.

## Training and Testing the Model

Training the model is simple after you have written the network definition
protobuf and solver protobuf files. Simply run
`./examples/triplet/train_mnist_triplet.sh`:

    ./examples/triplet/train_3d_triplet.sh

# Plotting the results

First, we can draw the model and triplet networks by running the following
commands that draw the DAGs defined in the .prototxt files:

    ./python/draw_net.py \
        ./examples/triplet/3d_triplet.prototxt \
        ./examples/triplet/3d_triplet.png

    ./python/draw_net.py \
        ./examples/triplet/3d_triplet_train_test.prototxt \
        ./examples/triplet/3d_triplet_train_test.png